# Dependency Update Guide for Serilog.Sinks.AzureDataExplorer

This guide provides comprehensive instructions for updating NuGet packages and .NET framework versions in the Serilog Azure Data Explorer sink project.

## Overview

The project uses **Central Package Management** via `Directory.Packages.props` located in the `src/` directory. All package versions are defined centrally in this file, and individual project files reference packages without specifying versions.

### Project Structure
- **Main Project**: `Serilog.Sinks.AzureDataExplorer` - Multi-targeted library (net9.0, net8.0, net6.0, netstandard2.0, net471, net462)
- **Sample Project**: `Serilog.Sinks.AzureDataExplorer.Samples` - Demo application (net8.0, net6.0)
- **Test Project**: `Serilog.Sinks.AzureDataExplorer.Tests` - Unit and E2E tests (net8.0, net6.0)

## Step 1: Check for Outdated Packages

Run these commands from the repository root to identify outdated packages across all projects:

```sh
dotnet list src/Serilog.Sinks.AzureDataExplorer/Serilog.Sinks.AzureDataExplorer.csproj package --outdated
```

```sh
dotnet list src/Serilog.Sinks.AzureDataExplorer.Samples/Serilog.Sinks.AzureDataExplorer.Samples.csproj package --outdated
```

```sh
dotnet list src/Serilog.Sinks.AzureDataExplorer.Tests/Serilog.Sinks.AzureDataExplorer.Tests.csproj package --outdated
```

### Understanding the Output
The commands will show:
- **Requested** version (current)
- **Resolved** version (what's actually being used)
- **Latest** version (newest available on NuGet)

Pay special attention to:
- Major version changes (may include breaking changes)
- Security vulnerabilities indicated in the output
- Deprecated packages

## Step 2: Update Package Versions

### Important: Edit Directory.Packages.props

All package versions must be updated in `src/Directory.Packages.props`, **NOT** in individual `.csproj` files.

#### Key Package Categories:

1. **Core Dependencies** (used across all projects):
   - `Microsoft.Azure.Kusto.Ingest` - Azure Data Explorer client
   - `Serilog` - Core logging framework
   - `Serilog.Formatting.Compact` - Compact JSON formatting
   - `Serilog.Sinks.File` - File-based logging for durable sink

2. **Microsoft.Extensions.*** Packages (configuration & DI):
   - Update all `Microsoft.Extensions.*` packages together to maintain compatibility
   - These include Configuration, Logging, DependencyInjection packages

3. **Framework-Conditional Dependencies**:
   - Some packages have different versions based on `TargetFramework` conditions
   - When upgrading, maintain the conditional logic (e.g., net6.0 vs net8.0 vs net9.0)
   - Example pattern:
     ```xml
     <PackageVersion Include="System.Text.Json" Version="8.0.0" Condition="'$(TargetFramework)' == 'net6.0'" />
     <PackageVersion Include="System.Text.Json" Version="9.0.0" Condition="'$(TargetFramework)' == 'net8.0'" />
     ```

4. **Test Dependencies**:
   - `Microsoft.NET.Test.Sdk` - Test platform
   - `xunit` and `xunit.runner.visualstudio` - Test framework
   - `coverlet.collector` - Code coverage
   - `FluentAssertions` - Assertion library
   - `Xunit.SkippableFact` - Conditional test execution

### Update Strategy:

1. **Minor/Patch Updates**: Generally safe, apply immediately
2. **Major Updates**: Review release notes for breaking changes
3. **Group Updates**: Update related packages together (e.g., all Serilog.* packages)
4. **Framework-Specific**: When updating System.* packages, ensure versions align with target frameworks

## Step 3: Update Target Frameworks (if needed)

### Current Target Frameworks:
- **Main Library**: net9.0, net8.0, net6.0, netstandard2.0, net471, net462
- **Tests & Samples**: net8.0, net6.0

### To Add a New Target Framework:

1. **Update Main Project** (`Serilog.Sinks.AzureDataExplorer.csproj`):
   ```xml
   <TargetFrameworks>$(TargetFrameworks);net10.0;net9.0;net8.0;net6.0;netstandard2.0</TargetFrameworks>
   ```

2. **Update Test Project** (`Serilog.Sinks.AzureDataExplorer.Tests.csproj`):
   ```xml
   <TargetFrameworks>net10.0;net9.0;net8.0</TargetFrameworks>
   ```

3. **Update Directory.Packages.props** with framework-specific package versions:
   ```xml
   <PackageVersion Include="System.Text.Json" Version="10.0.0" Condition="'$(TargetFramework)' == 'net10.0'" />
   ```

### To Remove an EOL Framework:
- Remove the framework from `<TargetFrameworks>` entries
- Remove or update conditional package references
- Check for framework-specific code using `#if` directives

## Step 4: Validate Changes

### Build Verification
From the `src/` directory:

```sh
dotnet clean
dotnet restore
dotnet build --configuration Release
```

This will:
- Clean previous build artifacts
- Restore packages from the updated Directory.Packages.props
- Build for all target frameworks
- Report any compilation errors

### Expected Build Output:
- All target frameworks should build successfully
- Watch for deprecation warnings
- Note any analyzer warnings about obsolete APIs

## Step 5: Run Tests with Coverage

### Prerequisites for E2E Tests:
The test suite includes End-to-End tests that require Azure Data Explorer credentials.

**Set environment variables** (ask user for these values):
```sh
export ingestionURI="<your-adx-ingestion-uri>"
export databaseName="<your-database-name>"
```

Example values:
- `ingestionURI`: `https://ingest-mycluster.region.kusto.windows.net`
- `databaseName`: `TestDatabase`

### Run Full Test Suite:
From the `src/` directory:

```sh
dotnet clean && dotnet test Serilog.Sinks.AzureDataExplorer.Tests/Serilog.Sinks.AzureDataExplorer.Tests.csproj --collect:"XPlat Code Coverage" --results-directory ../TestResults
```

This command:
1. Cleans previous builds
2. Runs all tests for all target frameworks (net8.0 and net6.0)
3. Collects code coverage using XPlat Code Coverage
4. Saves results to `../TestResults` directory

### Run Tests for Specific Framework:
```sh
dotnet test Serilog.Sinks.AzureDataExplorer.Tests/Serilog.Sinks.AzureDataExplorer.Tests.csproj --framework net8.0 --collect:"XPlat Code Coverage"
```

### View Coverage Report:
Coverage results are stored as `.cobertura.xml` files in the TestResults directory. You can:
- Use VS Code extensions like "Coverage Gutters" to visualize
- Generate HTML reports using `reportgenerator` tool
- Review in CI/CD pipeline dashboards

## Step 6: Post-Update Checklist

- [ ] All projects build without errors on all target frameworks
- [ ] All tests pass for all target frameworks
- [ ] No new compiler warnings introduced
- [ ] Code coverage remains stable or improves
- [ ] Review package dependency tree for conflicts: `dotnet list package --include-transitive`
- [ ] Update package release notes in `.csproj` files if doing a new release
- [ ] Update version numbers (`<AssemblyVersion>` and `<VersionPrefix>`) if releasing
- [ ] Commit changes with descriptive message (e.g., "chore: Update NuGet dependencies to latest versions")
- [ ] Create PR with summary of updated packages and any breaking changes

## Common Issues & Solutions

### Issue: Package Version Conflict
**Symptom**: Build warnings about version conflicts
**Solution**: Check transitive dependencies with `dotnet list package --include-transitive` and align versions

### Issue: Breaking API Changes
**Symptom**: Compilation errors after update
**Solution**: Review package release notes and migration guides, update code accordingly

### Issue: E2E Tests Fail
**Symptom**: Tests fail with authentication or connection errors
**Solution**: Verify environment variables are set correctly, check ADX cluster accessibility

### Issue: Framework-Specific Build Failures
**Symptom**: Build succeeds on some frameworks but fails on others
**Solution**: Review conditional package references and ensure appropriate versions for each framework

## Additional Notes

- **Multi-Targeting Complexity**: The project supports 6 target frameworks. Ensure compatibility across all.
- **Implicit Usings**: The project uses C# 10.0 with implicit usings enabled.
- **Strong-Naming**: Assemblies are signed with `adxSerilog.snk` in Release configuration.
- **Central Package Management**: Always update `Directory.Packages.props`, never individual project files.
- **Test Strategy**: Unit tests don't require ADX connection; E2E tests (marked with `[SkippableFact]`) need credentials.

## References

- [Central Package Management Docs](https://learn.microsoft.com/nuget/consume-packages/central-package-management)
- [.NET Framework Support Policy](https://dotnet.microsoft.com/platform/support/policy/dotnet-core)
- [Serilog Documentation](https://serilog.net/)
- [Azure Data Explorer .NET SDK](https://learn.microsoft.com/azure/data-explorer/kusto/api/netfx/about-the-sdk)
